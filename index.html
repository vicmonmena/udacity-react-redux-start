<!DOCTYPE html>
<html lang="en">
<head>
  <title>Udacity (vicmonmena) Todos Goals</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
  <script src="https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
  <script src="https://tylermcginnis.com/goals-todos-api/index.js"></script>
  <script src="https://unpkg.com/redux-thunk@2.2.0/dist/redux-thunk.min.js"></script>
</head>
<body>
  <div id="app"> </div>
  <script type="text/javascript">

    // Generate a random and unique ID
    function generateID() {
      return Math.random().toString(36).substring(2) + (new Date()).getTime().toString(36);
    }
    
    // APP CODE
    const ADD_TODO = 'ADD_TODO';
    const REMOVE_TODO = 'REMOVE_TODO';
    const TOOGLE_TODO = 'TOOGLE_TODO';
    const ADD_GOAL = 'ADD_GOAL';
    const REMOVE_GOAL = 'REMOVE_GOAL';
    const RECEIVE_DATA = 'RECEIVE_DATA';

    // Action CREATORS

    /**
     * Action creator
     * 
     * @param {any} todo 
     * @returns 
     */
    function addTodoAction(todo) {
      return {
        type: ADD_TODO,
        todo,
      }
    }

    /**
     * Action creator
     * 
     * @param {any} id 
     * @returns 
     */
    function removeTodoAction(id) {
      return {
        type: REMOVE_TODO,
        id,
      }
    }

    /**
     * Action creator
     * 
     * @param {any} todo 
     * @returns 
     */
    function toogleTodoAction(id) {
      return {
        type: TOOGLE_TODO,
        id,
      }
    }

    /**
     * Action creator
     * 
     * @param {any} goal 
     * @returns 
     */
    function addGoalAction(goal) {
      return {
        type: ADD_GOAL,
        goal,
      }
    }

    /**
     * Action creator
     * 
     * @param {any} id 
     * @returns 
     */
    function removeGoalAction(id) {
      return {
        type: REMOVE_GOAL,
        id,
      }
    }

    /**
     * Action creator
     * 
     * @param {any} id 
     * @returns 
     */
    function receiveDataAction(todos, goals) {
      return {
        type: RECEIVE_DATA,
        todos,
        goals
      }
    }
    
    /**
     * Action creator wich returns a function
     * 
     * @returns a function
     */ 
    function handleInitialData() {
      return (dispatch) => {
        Promise.all([API.fetchTodos(), API.fetchGoals()])
          .then(([todos, goals]) => {
            dispatch(receiveDataAction(todos, goals));
          });
      }
    }
    /**
     * Action creator wich returns a function
     * 
     * @param {any} todo
     * @returns a function
     */ 
     function handleAddTodo(todoName, cb) {
      return (dispatch) => {
        return API.saveTodo(todoName)
          .then((todo) => {
            dispatch(addTodoAction(todo));
            cb();
          }).catch((err) =>{
            alert('An error occurred adding todo item. Please, try again');
            cb();
          });
      }
    }

    /**
     * Action creator wich returns a function
     * 
     * @param {any} todo
     * @returns a function
     */ 
     function handleDeleteTodo(todo) {
      return (dispatch) => {
        dispatch(removeTodoAction(todo.id));
        return API.deleteTodo(todo.id).catch((err) => {
          dispatch(addTodoAction(todo));
          alert('An error occurred removing todo item. Please, try again')
        });
      }
    }

    /**
     * Action creator wich returns a function
     * 
     * @param {any} todo
     * @returns a function
     */ 
    function handleToogleTodo(todo) {
      return (dispatch) => {

        dispatch(toogleTodoAction(todo.id));
        return API.saveTodoToggle(todo.id).catch(() => {
          dispatch(toogleTodoAction(todo.id));
          alert('An error occurred toogling todo item. Please, try again')
        })
      }
    }

    /**
     * Action creator wich returns a function
     * 
     * @param {any} goalName
     * @param {any} cb
     * @returns a function
     */ 
    function handleAddGoal(goalName, cb) {
      return (dispatch) => {
        return API.saveGoal(goalName)
          .then((goal) => {
            dispatch(addGoalAction(goal));
            cb(); // callback for UI modifications or other independant actions from this logic
          }).catch((err) =>{
            alert('An error occurred adding goal item. Please, try again');
            cb();
          });
      }
    }

    /**
     * Action creator wich returns a function
     * 
     * @param {any} todo
     * @returns a function
     */ 
     function handleDeleteGoal(goal) {
      return (dispatch) => {
        dispatch(removeGoalAction(goal.id));
        return API.deleteGoal(goal.id).catch((err) => {
          dispatch(addGoalAction(goal));
          alert('An error occurred removing goal item. Please, try again')
        });
      }
    }

    // Esta función es un REDUCER, porque lo que hace es coger un estado en una action y reducirlo a un nuevo estado.
    // 'state = []' esto es de ES6
    // Esta función es una PURE FUNCTION
    function todos(state = [], action) {
      switch (action.type) {
        case ADD_TODO:
          return state.concat([action.todo]); // brand new state  
        case REMOVE_TODO:
          return state.filter((todo) => todo.id !== action.id);
        case TOOGLE_TODO:
          return state.map((todo) => todo.id !== action.id ? todo : 
            Object.assign({}, todo, { complete: !todo.complete }));
        case RECEIVE_DATA:
          return action.todos;
        default: return state;
      }
    }

    // 2ND REDUCER
    function goals(state = [], action) {
      switch (action.type) {
        case ADD_GOAL:
          return state.concat([action.goal]); // brand new state  
        case REMOVE_GOAL:
          return state.filter((goal) => goal.id !== action.id);
        case RECEIVE_DATA:
          return action.goals;
        default: return state;
      }
    }

    // 3RD REDUCER
    function loading(state = true, action) {
      switch (action.type) {
        case RECEIVE_DATA:
          return false;
        default: return state;
      }
    }

    /**
     * Middleware for intercept task related to bitcoins. 
     *
     */
    const checker = (store) => (next) => (action) => {
      if (action.type === ADD_TODO && action.todo.name.toLowerCase().includes('bitcoin')) {
        return alert('Nope! That is a bad idea');
      } 

      if (action.type === ADD_GOAL && action.goal.name.toLowerCase().includes('bitcoin')) {
        return alert('Nope! That is a bad idea');
      } 

      return next(action); 
    }

    /**
     * This middleware shows messages on developer console browser
     */
     const logger = (store) => (next) => (action) => {
      console.group(action.type)
        console.log('[INFO] This action is ', action);
        const result = next(action);
        console.log('[INFO] The new state is ', store.getState());
      console.groupEnd();

      return result; 
    }

    /* ************************************************** */
          /* **************** STORE ************* */
    /* ************************************************** */
    const store = Redux.createStore(Redux.combineReducers({
      todos,
      goals,
      loading
    }), Redux.applyMiddleware(ReduxThunk.default, checker, logger));
    /* ************************************************** */

    /**
     * Event click function for adding todo
     */
    function addTodo() {
      const input = document.getElementById('todo');
      const name = input.value;
      if ((name)) {
        input.value = ''; // Reseting field after submit
        // console.log('addTodo invoked with value: ', name)
        const todo = {
          id: generateID(),
          name,
          complete: false,
          // now we are not gonna use field 'done'
        };
        store.dispatch(addTodoAction(todo));
        
      } else {
        alert('Please, input can not be empty');
      }
    }

    /**
     * Event click function for adding goal
     */
    function addGoal() {
      const input = document.getElementById('goal');
      const name = input.value;
      if((name)) {
        input.value = ''; // Reseting field after submit
        // console.log('addGoal invoked with value: ', name)
        const goal = {
          id: generateID(),
          name,
          // now we are not gonna use field 'done'
        };
        store.dispatch(addGoalAction(goal));
        
      } else {
        alert('Please, input can not be empty');
      }
    }
    
    function createRemoveButton(handleOnClick) {
      const removeBtn = document.createElement('button');
      removeBtn.innerHTML = 'X'
      removeBtn.addEventListener('click', handleOnClick);
      return removeBtn;
    }
    /**
     * This function add a todo element to the list (DOM)
     */ 
    function addTodoToDOM(todo) {
      const node = document.createElement('li');
      const text = document.createTextNode(todo.name);
      const removeButton = createRemoveButton(() => {
        store.dispatch(removeTodoAction(todo.id))
      });
      node.appendChild(text);
      node.appendChild(removeButton)
      node.setAttribute('id', todo.id);
      // Showing element list in DOM
      document.getElementById('todos').appendChild(node);
      node.addEventListener('click', () => {
        store.dispatch(toogleTodoAction(todo.id));
      });
      node.style.textDecoration = todo.complete ? 'line-through' : 'none';
    }

    /**
     * This function add a goal element to the list (DOM)
     */ 
    function addGoalToDOM(goal) {
      const node = document.createElement('li');
      const text = document.createTextNode(goal.name);
      const removeButton = createRemoveButton(() => {
        store.dispatch(removeGoalAction(goal.id))
      })
      node.appendChild(text);
      node.appendChild(removeButton);
      node.setAttribute('id', goal.id);
      // Showing element list in DOM
      document.getElementById('goals').appendChild(node);
    }
  </script>
  <script type="text/babel">
    function List(props) {
      return(
        <ul id={props.id}>
          {props.items.map(item => (
            <li key={item.id}>
              <span 
                onClick={() => props.toogle && props.toogle(item)}
                style={{textDecoration: item.complete ? 'line-through' : 'none'}}>
                {item.name}
              </span>
              <button onClick={() => props.remove(item)}>
              X
              </button>
            </li>
          ))}
        </ul>
      )
    }
    
    class Todos extends React.Component {

      addItem = (event) => {
        event.preventDefault();
        this.props.store.dispatch(handleAddTodo(this.input.value, () => this.input.value = ''));
      }

      removeItem = (todo) => {
        this.props.store.dispatch(handleDeleteTodo(todo));
      }

      toogleItem = (todo) => {
        this.props.store.dispatch(handleToogleTodo(todo));
      }
      render() {
        return (
          <div>
            <h1>Todo List</h1>
            {
              this.props.loading &&
              <h3>Loading goals ...</h3>
            }
            {
              !this.props.loading &&
              <div>
                <input 
                  type="input"
                  placeholder="Add Todo"
                  ref={(input) => this.input = input}
                />
                <button onClick={this.addItem}>Add todo</button>
                <List 
                  id='todos'
                  toogle={this.toogleItem}
                  remove={this.removeItem} 
                  items={this.props.todos}
                />
              </div>
            }
          </div>
        )
      }
    }

    class Goals extends React.Component {
      
      addItem = (event) => {
        event.preventDefault();
        this.props.store.dispatch(handleAddGoal(this.input.value, () => this.input.value = ''));
      }

      removeItem = (goal) => {
        this.props.store.dispatch(handleDeleteGoal(goal));
      }

      render() {
        return (
          <div>
            <h1>Goal List</h1>
            {
              this.props.loading &&
              <h3>Loading goals ...</h3>
            }
            {
              !this.props.loading &&
              <div>
                <input 
                  type="input"
                  placeholder="Add Goal"
                  ref={(input) => this.input = input}
                />
                <button onClick={this.addItem}>Add goal</button>
                <List 
                  id='goals'
                  remove={this.removeItem} 
                  items={this.props.goals} 
                />
              </div>
            }
          </div>
        )
      }
    }

    class App extends React.Component {

      componentDidMount() {
        const { store } = this.props;
        // Initialing data from action creator thunk
        store.dispatch(handleInitialData());
        // forceUpdate: re-render of that specific component
        store.subscribe(() => this.forceUpdate())
      }

      render() {
        const { store } = this.props;
        const { todos, goals, loading } = store.getState();
        return(
          <div>
            <Todos loading={loading} todos={todos} store={store} />
            <Goals loading={loading} goals={goals} store={store} />
          </div>
        )
      }
    }

    ReactDOM.render(<App store={store}/>, document.getElementById('app'))
  </script>
</body>
</html>